!function(t){"use strict";function e(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);return t}function s(t){for(var e=[],s=t.length,r=t[0].length,n=0;s>n;n++)e=e.concat(t[n]);e=i(e);for(var a=[],o=0,h=0;s>h;h++){for(var l=[],c=0;r>c;c++)l.push(e[o]),o++;a.push(l)}return a}function i(t){for(var e,s,i=t.length;i;)s=Math.floor(Math.random()*i--),e=t[i],t[i]=t[s],t[s]=e;return t}function r(t,s){this.el=t,this.inner=this.el.querySelector("div"),this.allItems=[].slice.call(this.inner.children),this.allItemsCount=this.allItems.length,this.allItemsCount&&(this.items=[].slice.call(this.inner.querySelectorAll("figure:not([data-dummy])")),this.itemsCount=this.items.length,this.current=0,this.options=e({},this.options),e(this.options,s),this._init())}Modernizr.addTest("csstransformspreserve3d",function(){var e,s=Modernizr.prefixed("transformStyle"),i="preserve-3d";return s?(s=s.replace(/([A-Z])/g,function(t,e){return"-"+e.toLowerCase()}).replace(/^ms-/,"-ms-"),Modernizr.testStyles("#modernizr{"+s+":"+i+";}",function(i,r){e=t.getComputedStyle?getComputedStyle(i,null).getPropertyValue(s):""}),e===i):!1});var n={transitions:Modernizr.csstransitions,preserve3d:Modernizr.csstransformspreserve3d},a={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"},o=a[Modernizr.prefixed("transition")];r.prototype.options={},r.prototype._init=function(){this.currentItem=this.items[this.current],this._addNavigation(),this._getSizes(),this._initEvents()},r.prototype._addNavigation=function(){this.nav=document.createElement("nav");for(var t="",e=0;e<this.itemsCount;++e)t+="<span></span>";this.nav.innerHTML=t,this.el.appendChild(this.nav),this.navDots=[].slice.call(this.nav.children)},r.prototype._initEvents=function(){var e=this,s=classie.hasClass(this.el,"photostack-start"),i=function(){var t=function(){n.transitions&&classie.addClass(e.el,"photostack-transition")};s?(this.removeEventListener("click",i),classie.removeClass(e.el,"photostack-start"),t()):(e.openDefault=!0,setTimeout(t,25)),e.started=!0,e._showPhoto(e.current)};s?(this._shuffle(),this.el.addEventListener("click",i)):i(),this.navDots.forEach(function(t,s){t.addEventListener("click",function(){if(s===e.current)e._rotateItem();else{var t=function(){e._showPhoto(s)};e.flipped?e._rotateItem(t):t()}})}),t.addEventListener("resize",function(){e._resizeHandler()})},r.prototype._resizeHandler=function(){function t(){e._resize(),e._resizeTimeout=null}var e=this;this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(t,100)},r.prototype._resize=function(){var t=this,e=function(){t._shuffle(!0)};this._getSizes(),this.started&&this.flipped?this._rotateItem(e):e()},r.prototype._showPhoto=function(t){return this.isShuffling?!1:(this.isShuffling=!0,classie.hasClass(this.currentItem,"photostack-flip")&&(this._removeItemPerspective(),classie.removeClass(this.navDots[this.current],"flippable")),classie.removeClass(this.navDots[this.current],"current"),classie.removeClass(this.currentItem,"photostack-current"),this.current=t,this.currentItem=this.items[this.current],classie.addClass(this.navDots[this.current],"current"),this.currentItem.querySelector(".photostack-back")&&classie.addClass(this.navDots[t],"flippable"),void this._shuffle())},r.prototype._shuffle=function(t){var e=t?1:this.currentItem.getAttribute("data-shuffle-iteration")||1;(0>=e||!this.started||this.openDefault)&&(e=1),this.openDefault&&(classie.addClass(this.currentItem,"photostack-flip"),this.openDefault=!1,this.isShuffling=!1);var i=.5,r=Math.ceil(this.sizes.inner.width/(this.sizes.item.width*i)),a=Math.ceil(this.sizes.inner.height/(this.sizes.item.height*i)),h=r*this.sizes.item.width*i+this.sizes.item.width/2-this.sizes.inner.width,l=a*this.sizes.item.height*i+this.sizes.item.height/2-this.sizes.inner.height,c=h/2,p=l/2,m=35,d=-35,u=this,f=function(){--e;for(var t=[],h=0;a>h;++h)for(var l=t[h]=[],v=0;r>v;++v){var y=v*(u.sizes.item.width*i)-c,g=h*(u.sizes.item.height*i)-p,I=0,x=0;if(u.started&&0===e){var z=u._isOverlapping({x:y,y:g});if(z.overlapping){I=z.noOverlap.x,x=z.noOverlap.y;var _=Math.floor(3*Math.random());switch(_){case 0:I=0;break;case 1:x=0}}}l[v]={x:y+I,y:g+x}}t=s(t);var k=0,M=0,C=0;u.allItems.forEach(function(s,i){k===r-1?(M=M===a-1?0:M+1,k=1):++k;var h=(Math.floor(Math.random()*r),Math.floor(Math.random()*a),t[M][k-1]),l={x:h.x,y:h.y},c=function(){++C,n.transitions&&this.removeEventListener(o,c),C===u.allItemsCount&&(e>0?f.call():(classie.addClass(u.currentItem,"photostack-flip"),u.isShuffling=!1,"function"==typeof u.options.callback&&u.options.callback(u.currentItem)))};u.items.indexOf(s)===u.current&&u.started&&0===e?(u.currentItem.style.WebkitTransform="translate("+u.centerItem.x+"px,"+u.centerItem.y+"px) rotate(0deg)",u.currentItem.style.msTransform="translate("+u.centerItem.x+"px,"+u.centerItem.y+"px) rotate(0deg)",u.currentItem.style.transform="translate("+u.centerItem.x+"px,"+u.centerItem.y+"px) rotate(0deg)",u.currentItem.querySelector(".photostack-back")&&u._addItemPerspective(),classie.addClass(u.currentItem,"photostack-current")):(s.style.WebkitTransform="translate("+l.x+"px,"+l.y+"px) rotate("+Math.floor(Math.random()*(m-d+1)+d)+"deg)",s.style.msTransform="translate("+l.x+"px,"+l.y+"px) rotate("+Math.floor(Math.random()*(m-d+1)+d)+"deg)",s.style.transform="translate("+l.x+"px,"+l.y+"px) rotate("+Math.floor(Math.random()*(m-d+1)+d)+"deg)"),u.started&&(n.transitions?s.addEventListener(o,c):c())})};f.call()},r.prototype._getSizes=function(){this.sizes={inner:{width:this.inner.offsetWidth,height:this.inner.offsetHeight},item:{width:this.currentItem.offsetWidth,height:this.currentItem.offsetHeight}},this.centerItem={x:this.sizes.inner.width/2-this.sizes.item.width/2,y:this.sizes.inner.height/2-this.sizes.item.height/2}},r.prototype._isOverlapping=function(t){var e=this.sizes.item.width+this.sizes.item.width/3,s=this.sizes.item.height+this.sizes.item.height/3,i={x:this.sizes.inner.width/2-e/2,y:this.sizes.inner.height/2-s/2},r=this.sizes.item.width,n=this.sizes.item.height;if(!(t.x+r<i.x||t.x>i.x+e||t.y+n<i.y||t.y>i.y+s)){var a=Math.random()<.5,o=Math.floor(Math.random()*(r/4+1)),h=Math.floor(Math.random()*(n/4+1)),l=a?-1*(t.x-i.x+r)-o:i.x+e-(t.x+r)+r+o,c=a?-1*(t.y-i.y+n)-h:i.y+s-(t.y+n)+n+h;return{overlapping:!0,noOverlap:{x:l,y:c}}}return{overlapping:!1}},r.prototype._addItemPerspective=function(){classie.addClass(this.el,"photostack-perspective")},r.prototype._removeItemPerspective=function(){classie.removeClass(this.el,"photostack-perspective"),classie.removeClass(this.currentItem,"photostack-flip")},r.prototype._rotateItem=function(t){if(classie.hasClass(this.el,"photostack-perspective")&&!this.isRotating&&!this.isShuffling){this.isRotating=!0;var e=this,s=function(){n.transitions&&n.preserve3d&&this.removeEventListener(o,s),e.isRotating=!1,"function"==typeof t&&t()};this.flipped?(classie.removeClass(this.navDots[this.current],"flip"),n.preserve3d?(this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)"):classie.removeClass(this.currentItem,"photostack-showback")):(classie.addClass(this.navDots[this.current],"flip"),n.preserve3d?(this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)"):classie.addClass(this.currentItem,"photostack-showback")),this.flipped=!this.flipped,n.transitions&&n.preserve3d?this.currentItem.addEventListener(o,s):s()}},t.Photostack=r}(window);